package cli

import (
	"fmt"
	"io/ioutil"
	"net/http"

	log "github.com/sirupsen/logrus"

	"github.com/thedevsaddam/gojsonq"
)

func (n Nexus3) repositories() string {
	// Generated by curl-to-Go: https://mholt.github.io/curl-to-go
	log.Debug("Consult repositories URL: " + n.URL)
	req, err := http.NewRequest("GET", n.URL+"/service/rest/"+n.APIVersion+"/repositories", nil)
	if err != nil {
		log.Fatal(err)
	}
	req.Header.Set("Accept", "application/json")
	req.SetBasicAuth(n.User, n.Pass)

	resp, err := http.DefaultClient.Do(req)
	if err != nil {
		log.Fatal(err)
	}
	defer resp.Body.Close()

	var bodyString string
	if resp.StatusCode == http.StatusOK {
		bodyBytes, err := ioutil.ReadAll(resp.Body)
		if err != nil {
			log.Fatal(err)
		}
		bodyString = string(bodyBytes)
		if bodyString == "[ ]" {
			log.Fatal("Bodystring should not be empty. Did the authentication to '" + n.URL + "' succeed?")
		}
	}
	return bodyString
}

func repositoryNamesJSON(json string) interface{} {
	jq := gojsonq.New().JSONString(json)
	jq.SortBy("name", "asc")
	name := jq.Pluck("name")
	return name
}

func (n Nexus3) repositoriesSlice() []interface{} {
	return repositoryNamesJSON(n.repositories()).([]interface{})
}

func (n Nexus3) RepositoryNames() {
	for _, name := range n.repositoriesSlice() {
		fmt.Printf("%s\n", name)
	}
}

func (n Nexus3) CountRepositories() {
	fmt.Println(len(n.repositoriesSlice()))
}

// Downloads retrieves artifacts from all repositories
func (n Nexus3) Downloads() error {
	for _, name := range n.repositoriesSlice() {
		n := Nexus3{URL: n.URL, User: n.User, Pass: n.Pass, Repository: name.(string), APIVersion: n.APIVersion, ZIP: n.ZIP}
		err := n.StoreArtifactsOnDisk()
		if err != nil {
			return err
		}
	}

	// Add all download artifacts to a ZIP file
	n.CreateZip()

	return nil
}
